/*
Copyright © 2013 Adobe Systems Incorporated.

Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*//**
 * See <a href="http://jquery.com">http://jquery.com</a>.
 * @name jquery
 * @class
 * See the jQuery Library  (<a href="http://jquery.com">http://jquery.com</a>) for full details.  This just
 * documents the function and classes that are added to jQuery by this plug-in.
 *//**
 * See <a href="http://jquery.com">http://jquery.com</a>
 * @name fn
 * @class
 * See the jQuery Library  (<a href="http://jquery.com">http://jquery.com</a>) for full details.  This just
 * documents the function and classes that are added to jQuery by this plug-in.
 * @memberOf jquery
 *//**
 * @fileOverview accessibleMegaMenu plugin
 *
 *<p>Licensed under the Apache License, Version 2.0 (the “License”)
 *<br />Copyright © 2013 Adobe Systems Incorporated.
 *<br />Project page <a href="https://github.com/adobe-accessibility/Accessible-Mega-Menu">https://github.com/adobe-accessibility/Accessible-Mega-Menu</a>
 * @version 0.1
 * @author Michael Jordan
 * @requires jquery
 *//*jslint browser: true, devel: true, plusplus: true, nomen: true *//*global jQuery */(function(e,t,n){"use strict";function o(t,n){this.element=t;this.settings=e.extend({},i,n);this._defaults=i;this._name=r;this.init()}function u(t){return e.expr.filters.visible(t)&&!e(t).parents().addBack().filter(function(){return e.css(this,"visibility")==="hidden"}).length}function a(t,n){var r,i,s,o=t.nodeName.toLowerCase();if("area"===o){r=t.parentNode;i=r.name;if(!t.href||!i||r.nodeName.toLowerCase()!=="map")return!1;s=e("img[usemap=#"+i+"]")[0];return!!s&&u(s)}return(/input|select|textarea|button|object/.test(o)?!t.disabled:"a"===o?t.href||n:n)&&u(t)}var r="accessibleMegaMenu",i={uuidPrefix:"accessible-megamenu",menuClass:"accessible-megamenu",topNavItemClass:"accessible-megamenu-top-nav-item",panelClass:"accessible-megamenu-panel",panelGroupClass:"accessible-megamenu-panel-group",hoverClass:"hover",focusClass:"focus",openClass:"open"},s={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38,keyMap:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",190:"."}};o.prototype=function(){var r=0,i,u,a,f,l,c,h,p,d=1e3,v="",m=!!t.hasOwnProperty("ontouchstart"),g=!1,y,b,w,E,S,x,T,N,C,k,L,A;y=function(t){t=e(t);t.attr("id")||t.attr("id",i.uuidPrefix+"-"+(new Date).getTime()+"-"+ ++r)};b=function(t,r){var o=e(t.target),u=o.closest("."+i.topNavItemClass),f=o.hasClass(i.panelClass)?o:o.closest("."+i.panelClass),l;A(r);e("html").off("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu, pointerup.outside-accessible-megamenu",E);a.find("."+i.panelClass).off("DOMAttrModified.accessible-megamenu",S);if(r){u=a.find("."+i.topNavItemClass+" ."+i.openClass+":first").closest("."+i.topNavItemClass);if(!(u.is(t.relatedTarget)||u.has(t.relatedTarget).length>0)){if((t.type==="mouseout"||t.type==="focusout")&&u.has(n.activeElement).length>0)return;u.find("[aria-expanded]").attr("aria-expanded","false").removeClass(i.openClass).filter("."+i.panelClass).attr("aria-hidden","true");if(t.type==="keydown"&&t.keyCode===s.ESCAPE||t.type==="DOMAttrModified"){l=u.find(":tabbable:first");setTimeout(function(){l.focus();g=!1},99)}}else u.length===0&&a.find("[aria-expanded=true]").attr("aria-expanded","false").removeClass(i.openClass).filter("."+i.panelClass).attr("aria-hidden","true")}else{clearTimeout(c);u.siblings().find("[aria-expanded]").attr("aria-expanded","false").removeClass(i.openClass).filter("."+i.panelClass).attr("aria-hidden","true");u.find("[aria-expanded]").attr("aria-expanded","true").addClass(i.openClass).filter("."+i.panelClass).attr("aria-hidden","false");if(t.type==="mouseover"&&o.is(":tabbable")&&u.length===1&&f.length===0&&a.has(n.activeElement).length>0){o.focus();g=!1}A()}};w=function(t){var n=e(t.target),r=n.closest("."+i.topNavItemClass),s=n.closest("."+i.panelClass);if(r.length===1&&s.length===0&&r.find("."+i.panelClass).length===1)if(!n.hasClass(i.openClass)){t.preventDefault();t.stopPropagation();b(t)}else if(g){t.preventDefault();t.stopPropagation();g=!1}else if(m){t.preventDefault();t.stopPropagation();b(t,n.hasClass(i.openClass))}};E=function(t){if(a.has(e(t.target)).length===0){t.preventDefault();t.stopPropagation();b(t,!0)}};S=function(t){if(t.originalEvent.attrName==="aria-expanded"&&t.originalEvent.newValue==="false"&&e(t.target).hasClass(i.openClass)){t.preventDefault();t.stopPropagation();b(t,!0)}};x=function(t){clearTimeout(c);e(t.target).addClass(i.focusClass).on("click.accessible-megamenu",w);g=!0;l.filter("."+i.openClass).length&&b(t)};T=function(n){g=!1;var r=e(n.target),s=r.closest("."+i.topNavItemClass);r.removeClass(i.focusClass).off("click.accessible-megamenu",w);c=setTimeout(function(){b(n,!0)},300);t.cvox&&t.cvox.Api.getCurrentNode(function(e){s.has(e).length&&clearTimeout(c)})};N=function(n){var r=e(e(this).is(".hover:tabbable")?this:n.target),o=r.closest("."+i.topNavItemClass),u=a.find(":tabbable"),l=r.hasClass(i.panelClass)?r:r.closest("."+i.panelClass),c=l.find("."+i.panelGroupClass),h=r.closest("."+i.panelGroupClass),m,y=n.keyCode||n.which,E,S,x,T,N=!1,C=s.keyMap[n.keyCode]||"",k,L=o.length===1&&l.length===0;r.is(".hover:tabbable")&&e("html").off("keydown.accessible-megamenu");switch(y){case s.ESCAPE:b(n,!0);break;case s.DOWN:n.preventDefault();if(L){b(n);N=o.find("."+i.panelClass+" :tabbable:first").focus().length===1}else N=u.filter(":gt("+u.index(r)+"):first").focus().length===1;if(!N&&t.opera&&opera.toString()==="[object Opera]"&&(n.ctrlKey||n.metaKey)){u=e(":tabbable");S=u.index(r);N=e(":tabbable:gt("+e(":tabbable").index(r)+"):first").focus().length===1}break;case s.UP:n.preventDefault();if(L&&r.hasClass(i.openClass)){b(n,!0);m=f.filter(":lt("+f.index(o)+"):last");m.children("."+i.panelClass).length&&(N=m.children().attr("aria-expanded","true").addClass(i.openClass).filter("."+i.panelClass).attr("aria-hidden","false").find(":tabbable:last").focus()===1)}else L||(N=u.filter(":lt("+u.index(r)+"):last").focus().length===1);if(!N&&t.opera&&opera.toString()==="[object Opera]"&&(n.ctrlKey||n.metaKey)){u=e(":tabbable");S=u.index(r);N=e(":tabbable:lt("+e(":tabbable").index(r)+"):first").focus().length===1}break;case s.RIGHT:n.preventDefault();if(L)N=f.filter(":gt("+f.index(o)+"):first").find(":tabbable:first").focus().length===1;else{c.length&&h.length&&(N=c.filter(":gt("+c.index(h)+"):first").find(":tabbable:first").focus().length===1);N||(N=o.find(":tabbable:first").focus().length===1)}break;case s.LEFT:n.preventDefault();if(L)N=f.filter(":lt("+f.index(o)+"):last").find(":tabbable:first").focus().length===1;else{c.length&&h.length&&(N=c.filter(":lt("+c.index(h)+"):last").find(":tabbable:first").focus().length===1);N||(N=o.find(":tabbable:first").focus().length===1)}break;case s.TAB:S=u.index(r);if(n.shiftKey&&L&&r.hasClass(i.openClass)){b(n,!0);m=f.filter(":lt("+f.index(o)+"):last");m.children("."+i.panelClass).length&&(N=m.children().attr("aria-expanded","true").addClass(i.openClass).filter("."+i.panelClass).attr("aria-hidden","false").find(":tabbable:last").focus())}else if(n.shiftKey&&S>0)N=u.filter(":lt("+S+"):last").focus().length===1;else if(!n.shiftKey&&S<u.length-1)N=u.filter(":gt("+S+"):first").focus().length===1;else if(t.opera&&opera.toString()==="[object Opera]"){u=e(":tabbable");S=u.index(r);n.shiftKey?N=e(":tabbable:lt("+e(":tabbable").index(r)+"):last").focus().length===1:N=e(":tabbable:gt("+e(":tabbable").index(r)+"):first").focus().length===1}N&&n.preventDefault();break;case s.SPACE:if(L){n.preventDefault();w(n)}break;default:clearTimeout(p);v+=C!==v?C:"";if(v.length===0)return;p=setTimeout(function(){v=""},d);L&&!r.hasClass(i.openClass)?u=u.filter("."+i.topNavItemClass+" > :tabbable"):u=o.find(":tabbable");n.shiftKey&&(u=e(u.get().reverse()));for(S=0;S<u.length;S++){x=u.eq(S);if(x.is(r)){E=v.length===1?S+1:S;break}}k=new RegExp("^"+v.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),"i");for(S=E;S<u.length;S++){x=u.eq(S);T=e.trim(x.text());if(k.test(T)){N=!0;x.focus();break}}if(!N)for(S=0;S<E;S++){x=u.eq(S);T=e.trim(x.text());if(k.test(T)){x.focus();break}}}g=!1};C=function(e){h=setTimeout(function(){clearTimeout(c)},1)};k=function(t){clearTimeout(h);e(t.target).addClass(i.hoverClass);b(t);e(t.target).is(":tabbable")&&e("html").on("keydown.accessible-megamenu",N.bind(t.target))};L=function(t){e(t.target).removeClass(i.hoverClass);h=setTimeout(function(){b(t,!0)},250);e(t.target).is(":tabbable")&&e("html").off("keydown.accessible-megamenu")};A=function(t){if(t){e("html").off("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu",E);a.find("."+i.panelClass).on("DOMAttrModified.accessible-megamenu",S)}else{e("html").on("mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu",E);a.find("[aria-expanded=true]."+i.panelClass).on("DOMAttrModified.accessible-megamenu",S)}};return{constructor:o,init:function(){var t=this;i=t.settings;u=e(t.element);u.attr("role","navigation");a=u.children().first();a.addClass(i.menuClass);f=a.children();f.each(function(t,n){var r,s;n=e(n);n.addClass(i.topNavItemClass);r=n.find(":tabbable:first");s=n.children(":not(:tabbable):last");y(r);if(s.length){y(s);r.attr({"aria-haspopup":!0,"aria-owns":s.attr("id"),"aria-controls":s.attr("id"),"aria-expanded":!1});s.attr({role:"group","aria-expanded":!1,"aria-hidden":!0}).addClass(i.panelClass).not("[aria-labelledby]").attr("aria-labelledby",r.attr("id"))}});l=a.find("."+i.panelClass);a.on("focusin.accessible-megamenu",":tabbable, :focusable, ."+i.panelClass,x).on("focusout.accessible-megamenu",":tabbable, :focusable, ."+i.panelClass,T).on("keydown.accessible-megamenu",N).on("mouseover.accessible-megamenu",k).on("mouseout.accessible-megamenu",L).on("mousedown.accessible-megamenu",C);m&&a.on("touchstart.accessible-megamenu",w);a.find("hr").attr("role","separator")},getDefaults:function(){return this._defaults},getOption:function(e){return this.settings[e]},getAllOptions:function(){return this.settings},setOption:function(e,t,n){this.settings[e]=t;n&&this.init()}}}();e.fn[r]=function(t){return this.each(function(){e.data(this,"plugin_"+r)||e.data(this,"plugin_"+r,new o(this,t))})};e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(n){return!!e.data(n,t)}}):function(t,n,r){return!!e.data(t,r[3])},focusable:function(t){return a(t,!isNaN(e.attr(t,"tabindex")))},tabbable:function(t){var n=e.attr(t,"tabindex"),r=isNaN(n);return(r||n>=0)&&a(t,!r)}})})(jQuery,window,document);